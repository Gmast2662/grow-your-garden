<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover { background: #0056b3; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #chatMessages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>Multiplayer Test Page</h1>
    
    <div class="test-section">
        <h3>Connection Status</h3>
        <div id="connectionStatus" class="status disconnected">🔴 Disconnected</div>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="checkToken()">Check Token</button>
    </div>
    
    <div class="test-section">
        <h3>Chat Test</h3>
        <input type="text" id="testMessage" placeholder="Enter test message">
        <button onclick="sendTestMessage()">Send Message</button>
        <div id="chatMessages"></div>
    </div>
    
    <div class="test-section">
        <h3>Friends Test</h3>
        <button onclick="testFriends()">Test Friends List</button>
        <div id="friendsResult"></div>
    </div>
    
    <div class="test-section">
        <h3>Server Health</h3>
        <button onclick="checkServerHealth()">Check Server Health</button>
        <div id="healthResult"></div>
    </div>

    <script src="multiplayer.js"></script>
    <script>
        let multiplayer;
        
        // Initialize multiplayer
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('garden_game_token');
            if (token) {
                multiplayer = new MultiplayerManager();
                multiplayer.initialize(token).then(success => {
                    if (success) {
                        updateConnectionStatus(true);
                        console.log('Multiplayer initialized successfully');
                    } else {
                        updateConnectionStatus(false);
                        console.log('Failed to initialize multiplayer');
                    }
                });
                
                // Set up event listeners
                multiplayer.on('connection', () => updateConnectionStatus(true));
                multiplayer.on('disconnection', () => updateConnectionStatus(false));
                multiplayer.on('chat_message', (data) => {
                    addChatMessage(data);
                });
            } else {
                updateConnectionStatus(false, 'No token found');
            }
        });
        
        function updateConnectionStatus(connected, message = '') {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = '🟢 Connected' + (message ? ` - ${message}` : '');
                status.className = 'status connected';
            } else {
                status.textContent = '🔴 Disconnected' + (message ? ` - ${message}` : '');
                status.className = 'status disconnected';
            }
        }
        
        function testConnection() {
            if (multiplayer && multiplayer.isConnectedToServer()) {
                addResult('Connection test: ✅ Connected', 'success');
            } else {
                addResult('Connection test: ❌ Not connected', 'error');
            }
        }
        
        function checkToken() {
            const token = localStorage.getItem('garden_game_token');
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    addResult(`Token valid - User: ${payload.username}, ID: ${payload.id}`, 'success');
                } catch (error) {
                    addResult('Token invalid or corrupted', 'error');
                }
            } else {
                addResult('No token found', 'error');
            }
        }
        
        function sendTestMessage() {
            const message = document.getElementById('testMessage').value.trim();
            if (message && multiplayer) {
                multiplayer.sendMessage(message);
                addResult(`Message sent: "${message}"`, 'success');
                document.getElementById('testMessage').value = '';
            } else {
                addResult('Cannot send message - not connected or empty message', 'error');
            }
        }
        
        function testFriends() {
            if (multiplayer) {
                multiplayer.getFriends().then(friends => {
                    if (friends && friends.length > 0) {
                        addResult(`Found ${friends.length} friends`, 'success');
                    } else {
                        addResult('No friends found', 'success');
                    }
                }).catch(error => {
                    addResult(`Friends test failed: ${error.message}`, 'error');
                });
            } else {
                addResult('Multiplayer not initialized', 'error');
            }
        }
        
        function checkServerHealth() {
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    addResult(`Server health: ✅ ${data.status}, Uptime: ${Math.round(data.uptime)}s, Online users: ${data.onlineUsers}`, 'success');
                })
                .catch(error => {
                    addResult(`Server health check failed: ${error.message}`, 'error');
                });
        }
        
        function addChatMessage(data) {
            const chatDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `<strong>${data.senderName}:</strong> ${data.message}`;
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        
        function addResult(message, type) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            resultDiv.textContent = message;
            
            // Add to appropriate result area
            if (message.includes('Friends')) {
                document.getElementById('friendsResult').appendChild(resultDiv);
            } else if (message.includes('health')) {
                document.getElementById('healthResult').appendChild(resultDiv);
            }
        }
    </script>
</body>
</html>
